name: CI/CD Pipeline

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18.x'
  PYTHON_VERSION: '3.11'

jobs:
  lint-frontend:
    name: ğŸ¨ Frontend Lint & Format
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package.json
        
    - name: ğŸ“¦ Install frontend dependencies
      run: |
        cd frontend
        npm install --prefer-offline --no-audit
        
    - name: ğŸ“‹ Generate package-lock.json if missing
      run: |
        cd frontend
        if [ ! -f package-lock.json ]; then
          echo "ğŸ”§ Generating package-lock.json..."
          npm install --package-lock-only
        fi
        
    - name: ğŸ” Run ESLint
      run: |
        cd frontend
        npm run lint
        
    - name: âœ¨ Check Prettier formatting
      run: |
        cd frontend
        npm run format:check

  lint-test-backend:
    name: ğŸ Backend Lint & Test
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: admin123
          POSTGRES_DB: cryptovault_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt
        
    - name: ğŸ“¦ Install backend dependencies
      run: |
        cd backend
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ” Run Flake8 linting
      run: |
        cd backend
        echo "ğŸ” Running Flake8 Python linting..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --max-complexity=12 --max-line-length=88 --statistics
        
    - name: ğŸ§ª Run Pytest with coverage
      env:
        DATABASE_URL: postgresql://admin:admin123@localhost:5432/cryptovault_test
        POSTGRES_USER: admin
        POSTGRES_PASSWORD: admin123
        POSTGRES_DB: cryptovault_test
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        SECRET_KEY: test-secret-key-for-ci-pipeline-only
        FLASK_ENV: testing
      run: |
        cd backend
        echo "ğŸ§ª Running Pytest test suite with coverage..."
        pytest --cov=. --cov-report=xml --cov-report=term-missing --cov-report=html -v --tb=short
        
    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: backend/coverage.xml
        flags: backend
        name: backend-coverage
        fail_ci_if_error: false

  build-docker:
    name: ğŸ³ Docker Build & Test
    runs-on: ubuntu-latest
    needs: [lint-frontend, lint-test-backend]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ—ï¸ Build Docker images
      run: |
        echo "ğŸ—ï¸ Building all Docker services..."
        docker-compose build --no-cache
        echo "âœ… Docker images built successfully!"
        
    - name: ğŸš€ Test Docker containers startup
      run: |
        echo "ğŸš€ Starting containers in detached mode..."
        docker-compose up -d
        
        echo "â³ Waiting for services to be healthy..."
        timeout 300 bash -c '
          while true; do
            # Check if all services are running
            if docker-compose ps --format "table {{.Name}}\t{{.Status}}" | grep -v "Up" | grep -q "Exit\|Down"; then
              echo "âŒ Some services failed to start"
              docker-compose ps
              exit 1
            fi
            
            # Count healthy services
            BACKEND_HEALTHY=$(docker-compose ps --format "table {{.Name}}\t{{.Status}}" | grep -c "Up.*healthy" || echo "0")
            DB_HEALTHY=$(docker-compose ps db --format "table {{.Name}}\t{{.Status}}" | grep -c "Up.*healthy" || echo "0")
            TOTAL_EXPECTED=2
            
            echo "Healthy services: Backend($BACKEND_HEALTHY) DB($DB_HEALTHY) / Total($TOTAL_EXPECTED)"
            
            if [ "$BACKEND_HEALTHY" -ge 1 ] && [ "$DB_HEALTHY" -ge 1 ]; then
              echo "âœ… All critical services are healthy!"
              break
            fi
            
            docker-compose ps
            sleep 15
          done
        '
        
        echo "ğŸ” Testing service endpoints..."
        sleep 10
        
        # Test backend health endpoint
        echo "ğŸ” Testing backend health endpoint..."
        for i in {1..5}; do
          if curl -f -s http://localhost:5000/health > /dev/null 2>&1; then
            echo "âœ… Backend health check passed"
            break
          else
            echo "â³ Backend not ready, attempt $i/5..."
            sleep 10
            if [ $i -eq 5 ]; then
              echo "âŒ Backend health check failed after 5 attempts"
              exit 1
            fi
          fi
        done
        
        # Test frontend availability  
        echo "ğŸ” Testing frontend endpoint..."
        for i in {1..3}; do
          if curl -I -s http://localhost:5173 | grep -q "200 OK\|404 Not Found"; then
            echo "âœ… Frontend endpoint reachable"
            break
          else
            echo "â³ Frontend not ready, attempt $i/3..."
            sleep 5
            if [ $i -eq 3 ]; then
              echo "âš ï¸ Frontend endpoint check completed with warnings"
            fi
          fi
        done
        
    - name: ğŸ“‹ Show container status on failure
      if: failure()
      run: |
        echo "=== Docker Compose Status ==="
        docker-compose ps
        echo ""
        echo "=== Backend Logs ==="
        docker-compose logs --tail=50 backend
        echo ""
        echo "=== Frontend Logs ==="
        docker-compose logs --tail=50 frontend  
        echo ""
        echo "=== Database Logs ==="
        docker-compose logs --tail=50 db
        echo ""
        echo "=== Container Resource Usage ==="
        docker stats --no-stream
        
    - name: ğŸ§¹ Cleanup Docker containers
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up Docker resources..."
        docker-compose down -v --remove-orphans
        docker system prune -af --volumes
        echo "âœ… Docker cleanup completed"

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [build-docker]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'
        
    - name: ğŸ“Š Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  deploy-status:
    name: ğŸ‰ Deployment Status
    runs-on: ubuntu-latest
    needs: [lint-frontend, lint-test-backend, build-docker, security-scan]
    if: always()
    
    steps:
    - name: ğŸ¯ Report CI/CD Status
      run: |
        echo "=== CryptoVaultX CI/CD Pipeline Results ==="
        echo "Frontend Lint: ${{ needs.lint-frontend.result }}"
        echo "Backend Test: ${{ needs.lint-test-backend.result }}" 
        echo "Docker Build: ${{ needs.build-docker.result }}"
        echo "Security Scan: ${{ needs.security-scan.result }}"
        echo ""
        
        if [[ "${{ needs.lint-frontend.result }}" == "success" && 
              "${{ needs.lint-test-backend.result }}" == "success" && 
              "${{ needs.build-docker.result }}" == "success" ]]; then
          echo "ğŸ‰ All checks passed! Ready for deployment."
          echo "âœ… Code quality: PASSED"
          echo "âœ… Tests: PASSED" 
          echo "âœ… Docker build: PASSED"
          exit 0
        else
          echo "âŒ Some checks failed. Please review the errors above."
          exit 1
        fi
